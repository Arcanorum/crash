!function(t){"use strict";"function"==typeof define&&define.amd?define(["RBush","SAT"],t):"object"==typeof exports?module.exports=t(require("rbush"),require("sat")):window.Crash=t(window.rbush,window.SAT)}(function(t,e){"use strict";var s={RBush:t,SAT:e,Vector:e.Vector,V:e.Vector,Response:e.Response,rbush:null,RESPONSE:new e.Response,BREAK:!1,MAX_CHECKS:100,OVERLAP_LIMIT:.5,__listeners:[],__notYetInserted:[],__moved:[]};s.extend=function(t,e){t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})},s.reset=function(t){return this.clear(),this.__listeners=[],this.BREAK=!1,this.MAX_CHECKS=100,this.OVERLAP_LIMIT=.5,this.RESPONSE.clear(),this.init(t),this},s.onCollision=function(t){return this.__listeners.push(t),this},s.offCollision=function(t){var e=this.__listeners.indexOf(t);return e>-1&&this.__listeners.splice(e,1),this},s.__onCollision=function(t,e,s){for(var i=0,n=this.__listeners.length;n>i;i++)this.__listeners[i].call(this,t,e,s,this.cancel);return this},s.cancel=function(){return s.BREAK=!0,!1},s.getTestString=function(t,e){return"circle"===t?"circle"===e?"testCircleCircle":"testCirclePolygon":"circle"===e?"testPolygonCircle":"testPolygonPolygon"},s.init=function(e){this.rbush=new t(e||9,[".aabb.x1",".aabb.y1",".aabb.x2",".aabb.y2"]);for(var s=0,i=this.__notYetInserted.length;i>s;s++)this.rbush.insert(this.__notYetInserted.pop());return this},s.insert=function(t){return this.rbush?this.rbush.insert(t):this.__notYetInserted.push(t),this},s.remove=function(t){if(this.rbush)this.rbush.remove(t);else{var e=this.__notYetInserted.indexOf(t);e>-1&&this.__notYetInserted.splice(e,1)}return this},s.all=function(){return this.rbush?this.rbush.all():this.__notYetInserted};var i=[];s.search=function(t){if(this.rbush){i[0]=t.aabb.x1,i[1]=t.aabb.y1,i[2]=t.aabb.x2,i[3]=t.aabb.y2;for(var e=this.rbush.search(i),s=0;s<e.length;s++)e[s]===t&&e.splice(s,1);return e}return[]},s.clear=function(){return this.rbush&&this.rbush.clear(),this.__moved=[],this.__notYetInserted=[],this},s.addToMoved=function(t){return-1===this.__moved.indexOf(t)&&this.__moved.push(t),this},s.update=function(t){return this.updateAABB(t),this.remove(t),this.insert(t),this},s.moved=function(t){return this.update(t),this.addToMoved(t),this},s.updateAABB=function(t){switch(t.type){case"polygon":return s.updateAABBPolygon(t);case"box":return s.updateAABBBox(t);case"circle":return s.updateAABBCircle(t);case"point":return s.updateAABBPoint(t)}},s.updateAABBPolygon=function(t){for(var e=t.aabb,s=t.sat.pos,i=t.sat.calcPoints,n=i.length,r=i[0].x,o=i[0].y,h=i[0].x,a=i[0].y,u=1;n>u;u++){var c=i[u];c.x<r?r=c.x:c.x>h&&(h=c.x),c.y<o?o=c.y:c.y>a&&(a=c.y)}e.x1=s.x+r,e.y1=s.y+o,e.x2=s.x+h,e.y2=s.y+a},s.updateAABBBox=function(t){var e=t.sat.calcPoints,s=t.aabb;s.x1=e[0].x,s.y1=e[0].y,s.x2=e[2].x,s.y2=e[2].y},s.updateAABBCircle=function(t){var e=t.aabb,s=t.sat.r,i=t.sat.pos;e.x1=i.x-s,e.y1=i.y-s,e.x2=i.x+s,e.y2=i.y+s},s.updateAABBPoint=function(t){var e=t.aabb,s=t.sat.pos;e.x1=e.x2=s.x,e.y1=e.y2=s.x},s.test=function(t,s,i){var i=i||this.RESPONSE,n=this.getTestString(t.type,s.type);return i.clear(),e[n](t.sat,s.sat,i)},s.testAll=function(t,s){var s=s||this.RESPONSE,i=this.search(t);t:for(var n=0,r=i.length;r>n;n++){var o=i[n],h=this.getTestString(t.type,o.type);if(s.clear(),e[h](t.sat,o.sat,s)&&(!this.OVERLAP_LIMIT||Math.abs(s.overlap)>this.OVERLAP_LIMIT)&&(this.__onCollision(t,o,s),this.BREAK))break t}t.lastPos.copy(t.pos);var a=this.BREAK;return this.BREAK=!1,!a};var n=[];s.check=function(t){for(var e=0;this.__moved.length&&e<this.MAX_CHECKS;){var s=this.__moved.pop(),i=n.indexOf(s);-1===i&&n.push(s),this.testAll(s,t),e++}for(var e=0,r=n.length;r>e;e++)n[e].lastCheckedPos.copy(n[e].pos);return n.length=0,this},s.checkAll=function(t){for(var e=this.all(),s=0,i=e.length;i>s;s++)this.testAll(e[s],t);return this.check(t),this};var r=s.Collider=function(t,e,i,n){return this.type=t,this.sat=e,this.data=n,this.pos=this.sat.pos,this.lastPos=this.pos.clone(),this.lastCheckedPos=this.pos.clone(),this.aabb={},s.updateAABB(this),i&&s.insert(this),this};r.prototype.insert=function(){return s.insert(this),this},r.prototype.remove=function(){return s.remove(this),this},r.prototype.update=function(){return s.update(this),this},r.prototype.updateAABB=function(){return s.updateAABB(this),this},r.prototype.moved=function(){return s.moved(this),this},r.prototype.search=function(){return s.search(this)},r.prototype.setData=function(t){return this.data=t,this},r.prototype.getData=function(){return this.data},r.prototype.moveTo=function(t,e){return this.sat.pos.x=t,this.sat.pos.y=e,this.moved(),this},r.prototype.moveBy=r.prototype.move=function(t,e){return this.sat.pos.x+=t,this.sat.pos.y+=e,this.moved(),this};var o=s.Polygon=function(t,s,i,n){var o=new e.Polygon(t,s);return r.call(this,"polygon",o,i,n),this};s.extend(o,r),o.prototype.setPoints=function(t){return this.sat.setPoints(t),this.moved(),this},o.prototype.setAngle=function(t){return this.sat.setAngle(t),this.moved(),this},o.prototype.setOffset=function(t){return this.sat.setOffset(t),this.moved(),this},o.prototype.rotate=function(t){return this.sat.rotate(t),this.moved(),this};var h=s.Circle=function(t,s,i,n){var o=new e.Circle(t,s);return r.call(this,"circle",o,i,n),this};s.extend(h,r);var a=s.Point=function(t,s,i){var n=new e.Box(t,1,1).toPolygon();return r.call(this,"point",n,s,i),this};s.extend(a,r);var u=s.Box=function(t,s,i,n,o){var h=new e.Box(t,s,i).toPolygon();return r.call(this,"box",h,n,o),this};return s.extend(u,r),s});
